<!DOCTYPE html>
<html>
    <head>
        <title>Tiny noVNC Player</title>

	<style type="text/css">
	    body { background-color:#eee; font-size:12px; font-family:'Tahoma', 'Verdana'; text-align:center }
	    body,a,input,span { vertical-align:middle }
	    div { white-space:nowrap; overflow-x:auto }

	    div a { text-decoration: none; outline: none; }
	    h1 a { text-decoration: none; outline: none; color:#000 }
	    #session { font-size: 110%; vertical-align: top }
	    #iterations { width:30px; }

	    #startButton { width:100px; }
	    #trackBar { width: 368px; display:none; }
	    #messages { font-size:9; margin: 0 auto; display:none }
	</style>
    </head>
    <body>

	<h1><a href="http://tinylab.org" target="_blank" title="Based on noVNC/tests/vnc_plaback.html and improved by TinyLab.org">Tiny noVNC Player</a></h1>

        <div id="VNC_control">
	    <div><a href="#VNC_canvas" title="Goto the video"><span id="session"></span></a>&nbsp;&nbsp;<span id="loop" title="total iterations"></span><a> . </a><span id="iteration" title="current iteration"></span><a> . </a><span id="size" title="total frames"></span><a> . </a><span id="skipframes" title="frames to skip"></span><a> . </a><span id="frame_idx" title="current frame and percentage"></span></div><br>

	    <input id='startButton' type='button' value='Start' onclick="start();" disabled>
	    <input type="range" id="trackBar" min="1" max="10" step="1" value="1" ontouchstart='track_stop();' onmousedown='track_stop();' ontouchmove='track_move();' onmousemove='track_move();' ontouchend='track_start();' onmouseup='track_start();' /><br>

	    <div id='buttons' style="display: none;"><br>
	    &nbsp; <a>Fullspeed: </a><input type='radio' id='mode1' name='mode' onclick='mode1_checked();'>
	    &nbsp; <a>Realtime: </a><input type='radio' id='mode2' name='mode' checked>
	    &nbsp; <a>Iterations: </a><input id='iterations'>
	    <br><br></div>

            <textarea id="messages" cols=80 rows=10></textarea><br>
        </div>

        <div id="VNC_screen">
            <canvas id="VNC_canvas" width="480px" height="20px">
                Canvas not supported.
            </canvas>
            <div id="VNC_status_bar" class="VNC_status_bar">
                <table border=0 width=100%><tr>
                    <td><div id="VNC_status">Loading</div></td>
                </tr></table>
            </div>
        </div>
    </body>

    <!--
    <script type='text/javascript'
        src='http://getfirebug.com/releases/lite/1.2/firebug-lite-compressed.js'></script>
    -->

    <script type="text/javascript">
        var INCLUDE_URI= "./";
    </script>
    <script src="./core/util.js"></script>
    <script src="./app/webutil.js"></script>

    <script>
	// play Stats
        var playStats = {
	    INIT: 0,
	    LOADING: 1,
	    RUNNING: 2,
	    STOPPED: 3,
	    FINISH: 4,
        };
	var trackBarStats = {
	    INIT: 0,
	    DOWN: 1,
	    MOVE: 2,
	    UP: 3,
	}
	var trackbar_stats = trackBarStats.INIT;

        var fname, start_time, play_stats, skipframes, messageon;
	var trackbar = document.getElementById('trackBar');
	var cell = document.getElementById('messages');
	var iter = document.getElementById('iteration');
	var fidx = document.getElementById('frame_idx');
	var session = document.getElementById('session');
	var vnc_status = document.getElementById('VNC_status');
	var start_btn = document.getElementById('startButton');
	var jumpto = document.getElementById('skipframes');
	var size = document.getElementById('size');
	var loop = document.getElementById('loop');
	var iters = document.getElementById('iterations');
	var mode1 = document.getElementById('mode1');
	var mode2 = document.getElementById('mode2');

        play_stats = playStats.INIT;

        function message(str) {
	    if (messageon) {
                console.log(str);
                cell.textContent += str + "\n";
                cell.scrollTop = cell.scrollHeight;
	    }
        }

        function ___updatestats(iteration, frame_idx) {
	    iter.textContent = iteration;
	    if (fname)
		fidx.textContent = (frame_idx+1) + " . " + parseInt((frame_idx + 1)*100/VNC_frame_data.length) + "%";

	    if ((frame_idx > skipframes) && ___playing())
		trackbar.value = frame_idx + 1;
        }

	function ___playing() {
	    return ((play_stats !== playStats.STOPPED) && (play_stats != playStats.FINISH))
	}

        fname = WebUtil.getQueryVar('data', null);
        if (fname) {
            message("Loading " + fname);

	    session.textContent = "#"+ fname;
	    vnc_status.textContent = "Loading";

            // Load supporting scripts
            WebUtil.load_scripts({
                'core': ["base64.js", "websock.js", "des.js", "input/keysym.js",
                         "input/keysymdef.js", "input/xtscancodes.js", "input/util.js",
                         "input/devices.js", "display.js", "rfb.js", "inflator.js"],
                'tests': ["playback.js"],
                'recordings': [fname]});

            play_stats = playStats.LOADING;

        } else {
            vnc_status.textContent = 'Must specify data=FOO in query string.';
            message("Must specify data=FOO in query string.");
        }

        disconnected = function (rfb, reason) {
            if (reason) {
                message("noVNC sent '" + state + "' state during iteration " + iteration + " frame " + frame_idx);
                test_state = 'failed';
            }
        }

        notification = function (rfb, mesg, level, options) {
            vnc_status.textContent = mesg;
        }

        function __start() {
            play_stats = playStats.RUNNING;
	    start_btn.value = 'Stop';
	    vnc_status.textContent = "Running";
            message("Start play the " + skipframes + " Frame");

            iteration = 0;
            start_time = (new Date()).getTime();
            //recv_message = rfb.testMode(send_array, VNC_frame_encoding);

            next_iteration();
        }

	function __stop() {
	    play_stats = playStats.STOPPED;

	    start_btn.value = 'Continue';
	    vnc_status.textContent = "Stopped";
	    message("Stopped at the " + frame_idx + " frame!");
	}

	function ___stop() {
	    __stop();
	    start_btn.disabled = false;
	    trackBar.disabled = false;
	}

	function __continue() {
	    start_btn.value = 'Stop';
	    vnc_status.textContent = "Continued";

	    if (mode === 'fullspeed') { window.setImmediate(do_packet); }
	    else {
		setTimeout(do_packet, delay);
	        istart_time = (new Date()).getTime() - toffset;
	    }

	    if ((frame_idx < skipframes) && (mode === 'realtime'))
	        mode = 'fullspeed';

	    play_stats = playStats.RUNNING;
	    message("Continue play the " + frame_idx + " frame!");
	}

	function start() {
            skipframes = jumpto.textContent;
            iterations = iters.value;

            if (mode1.checked || (skipframes > frame_idx)) {
                message("Starting performance playback (fullspeed) [" + iterations + " iteration(s)]");
                mode = 'fullspeed';
            } else {
                message("Starting realtime playback [" + iterations + " iteration(s)]");
                mode = 'realtime';
            }

            //console.info("play stats is " + play_stats);
	    if (play_stats != playStats.RUNNING) {

	        if (mode === "fullspeed") {
		    start_btn.disabled = true;
		    trackBar.disabled = true;
	        }

		if (play_stats === playStats.STOPPED)
		    __continue();
		else
		    __start();
	    } else {
		__stop();
	    }
	}

	function mode1_checked() {
	    jumpto.textContent = "0";
	}

	function track_stop() {
	    if (trackBar.disabled)
		return;

	    start_btn.disabled = true;
	    //console.info("trackBar stats is " + trackbar_stats);
	    trackbar_stats = trackBarStats.DOWN;
	    if (fname) {
		if (frame_idx < VNC_frame_data.length) {
		    __stop();
		}
	    }
	}

	function track_move() {
	    if (trackBar.disabled)
		return;

	    //console.info("trackBar stats is " + trackbar_stats);
	    if ((trackbar_stats === trackBarStats.DOWN) || (trackbar_stats === trackBarStats.MOVE)) {
		if ((play_stats === playStats.STOPPED) || (play_stats === playStats.FINISH)) {
	            jumpto.textContent = trackbar.value;
		}
	        trackbar_stats = trackBarStats.MOVE;
	    }
	}

	function track_start() {
	    if (trackBar.disabled)
		return;

	    //console.info("trackBar stats is " + trackbar_stats);
	    track_move();

	    trackBar.disabled = true;
	    trackbar_stats = trackBarStats.UP;
	    message("Start track_start()");
	    //console.info("jumpto.value is " + jumpto.textContent + " trackbar.value is " + trackbar.value);
	    if (frame_idx > trackbar.value)
		finish();
	    start();
	}

        function finish() {
            // Finished with all iterations
            var total_time, end_time = (new Date()).getTime();
            total_time = end_time - start_time;

            iter_time = parseInt(total_time / iterations, 10);
            message(iterations + " iterations took " + total_time + "ms, " +
                    iter_time + "ms per iteration");
            // Shut-off event interception
            rfb.get_mouse().ungrab();
            rfb.get_keyboard().ungrab();
            play_stats = playStats.FINISH;

            start_btn.value = "Start";
            vnc_status.textContent = "Finished";
        }

	function ___finish() {
	    start_btn.disabled = false;
	    trackBar.disabled = false;
	    finish();
	}

        window.onscriptsload = function () {
            iterations = WebUtil.getQueryVar('iterations', 1);
            skipframes = WebUtil.getQueryVar('skipframes', 0);
            messageon = WebUtil.getQueryVar('message', 0);

            iters.value = iterations;
            jumpto.textContent = skipframes;
	    loop.textContent = iterations;
            mode = WebUtil.getQueryVar('mode', 3);

            if (mode === 'fullspeed') {
                mode1.checked = true;
            } else {
                mode2.checked = true;
            }
            if (messageon) {
		buttons.style.display = 'block';
                cell.style.display = 'block';
            }
            if (fname) {
                message("VNC_frame_data.length: " + VNC_frame_data.length);
                trackbar.max = VNC_frame_data.length;
	        size.textContent = trackbar.max;
                trackbar.style.display = "inline-block";
            }
            // Play immediately after load the data
            start_btn.disabled = false;
            vnc_status.textContent = "Loaded";

            start();
        }
    </script>
</html>
