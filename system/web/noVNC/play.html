<!DOCTYPE html>
<html>
    <head>
        <title>TinyLab.org noVNC Player</title>

	<style type="text/css">
	    body { background-color:#eee; font-size:12px; font-family:'Tahoma', 'Verdana' }
	    input,span { vertical-align:middle }
	    a { font-size:80%; vertical-align:middle  }

	    #session { color:#f00 }
	    #iteration { color:#33f }
	    #frame_idx { color:#00f }
	    #iterations { width:30px; text-align:center }
	    #skipframes { width:30px; text-align:center }

	    #startButton { width:80px; }
	    #trackBar { display:none; }
	    #messages { font-size:9; margin-top:12px; display:none }
	</style>
    </head>
    <body>

        <div id="VNC_control">
	    <input id='startButton' type='button' value='Start' onclick="start();" disabled>
	    <input type="range" id="trackBar" min="1" max="10" step="1" value="1" onmousedown='track_stop();' onmousemove='track_move();' onmouseup='track_start();' />

	    &nbsp; <a>Session: </a><span id="session"></span><a>:</a><span id="iteration"></span><a>:</a><span id="frame_idx"></span>
	    &nbsp; <a>Fullspeed: </a><input type='radio' id='mode1' name='mode' onclick='mode1_checked();'>
	    &nbsp; <a>Realtime: </a><input type='radio' id='mode2' name='mode' checked>
	    &nbsp; <a>Iterations: </a><input id='iterations'>
	    &nbsp; <a>skipFrames: </a><input id='skipframes'><br>
            <textarea id="messages" cols=80 rows=5></textarea><br>
        </div>

        <div id="VNC_screen">
            <canvas id="VNC_canvas" width="480px" height="20px">
                Canvas not supported.
            </canvas>
            <div id="VNC_status_bar" class="VNC_status_bar" style="margin-top: 0px">
                <table border=0 width=100%><tr>
                    <td><div id="VNC_status" style="text-align: center">Loading</div></td>
                </tr></table>
            </div>
        </div>
    </body>

    <!--
    <script type='text/javascript'
        src='http://getfirebug.com/releases/lite/1.2/firebug-lite-compressed.js'></script>
    -->

    <script type="text/javascript">
        var INCLUDE_URI= "./";
    </script>
    <script src="./core/util.js"></script>
    <script src="./app/webutil.js"></script>

    <script>
	// play Stats
        var playStats = {
	    INIT: 0,
	    LOADING: 1,
	    RUNNING: 2,
	    STOPPED: 3,
	    FINISH: 4,
        };
	var traceBarStats = {
	    INIT: 0,
	    DOWN: 1,
	    MOVE: 2,
	    UP: 3,
	}
	var tracebar_stats = traceBarStats.INIT;

        var fname, start_time, play_stats;
	var trackbar = document.getElementById('trackBar');
	var cell = document.getElementById('messages');
	var iter = document.getElementById('iteration');
	var fidx = document.getElementById('frame_idx');
	var session = document.getElementById('session');
	var vnc_status = document.getElementById('VNC_status');
	var start_btn = document.getElementById('startButton');
	var jumpto = document.getElementById('skipframes');
	var iters = document.getElementById('iterations');
	var mode1 = document.getElementById('mode1');
	var mode2 = document.getElementById('mode2');

        play_stats = playStats.INIT;

        function message(str) {
            console.log(str);
            cell.textContent += str + "\n";
            cell.scrollTop = cell.scrollHeight;
        }

        function updatestats(iteration, frame_idx) {
	    iter.textContent = iteration;
	    fidx.textContent = frame_idx + 1;

            trackbar.value = frame_idx + 1;
        }

        fname = WebUtil.getQueryVar('data', null);
        if (fname) {
            message("Loading " + fname);

	    session.textContent = fname;
	    vnc_status.textContent = "Loading";

            // Load supporting scripts
            WebUtil.load_scripts({
                'core': ["base64.js", "websock.js", "des.js", "input/keysym.js",
                         "input/keysymdef.js", "input/xtscancodes.js", "input/util.js",
                         "input/devices.js", "display.js", "rfb.js", "inflator.js"],
                'tests': ["playback.js"],
                'recordings': [fname]});

            play_stats = playStats.LOADING;

        } else {
            vnc_status.textContent = 'Must specify data=FOO in query string.';
            message("Must specify data=FOO in query string.");
        }

        disconnected = function (rfb, reason) {
            if (reason) {
                message("noVNC sent '" + state + "' state during iteration " + iteration + " frame " + frame_idx);
                test_state = 'failed';
            }
        }

        notification = function (rfb, mesg, level, options) {
            vnc_status.textContent = mesg;
        }

        function __start() {
            play_stats = playStats.RUNNING;
	    start_btn.value = 'Stop';
	    vnc_status.textContent = "Running";
            message("Start play the " + skipframes + " Frame");

            iteration = 0;
            start_time = (new Date()).getTime();
            //recv_message = rfb.testMode(send_array, VNC_frame_encoding);

            next_iteration();
        }

	function __stop() {
	    play_stats = playStats.STOPPED;

	    start_btn.value = 'Continue';
	    start_btn.disabled = false;
	    vnc_status.textContent = "Stopped";
	    message("Stopped at the " + frame_idx + " frame!");
	}

	function __continue() {
	    start_btn.value = 'Stop';
	    vnc_status.textContent = "Continued";

	    if (mode === 'fullspeed') { window.setImmediate(do_packet); }
	    else { setTimeout(do_packet, delay); }

	    if ((frame_idx < skipframes) && (mode === 'realtime'))
	        mode = 'fullspeed';

	    play_stats = playStats.RUNNING;
	    message("Continue play the " + frame_idx + " frame!");
	}

	function start() {
            skipframes = jumpto.value;
            iterations = iters.value;

            if (mode1.checked || (skipframes > frame_idx)) {
                message("Starting performance playback (fullspeed) [" + iterations + " iteration(s)]");
                mode = 'fullspeed';
            } else {
                message("Starting realtime playback [" + iterations + " iteration(s)]");
                mode = 'realtime';
            }

            //console.info("play stats is " + play_stats);
	    if (play_stats != playStats.RUNNING) {
		if (play_stats === playStats.STOPPED)
		    __continue();
		else
		    __start();
	    } else {
		__stop();
	    }
	}

	function mode1_checked() {
	    jumpto.value = 0;
	}

	function track_stop() {
	    //console.info("traceBar stats is " + tracebar_stats);
	    tracebar_stats = traceBarStats.DOWN;
	    if (fname) {
		if (frame_idx < VNC_frame_data.length) {
		    __stop();
		    finish();
		}
	    }
	}

	function track_move() {
	    //console.info("traceBar stats is " + tracebar_stats);
	    if ((tracebar_stats === traceBarStats.DOWN) || (tracebar_stats === traceBarStats.MOVE)) {
		if ((play_stats === playStats.STOPPED) || (play_stats === playStats.FINISH))
	            jumpto.value = trackbar.value;
	        tracebar_stats = traceBarStats.MOVE;
	    }
	}

	function track_start() {
	    //console.info("traceBar stats is " + tracebar_stats);
	    track_move();
	    message("Start play in 2s");
	    setTimeout(start, 2000);
	    tracebar_stats = traceBarStats.UP;
	}

        function finish() {
            // Finished with all iterations
            var total_time, end_time = (new Date()).getTime();
            total_time = end_time - start_time;

            iter_time = parseInt(total_time / iterations, 10);
            message(iterations + " iterations took " + total_time + "ms, " +
                    iter_time + "ms per iteration");
            // Shut-off event interception
            rfb.get_mouse().ungrab();
            rfb.get_keyboard().ungrab();
            play_stats = playStats.FINISH;

            start_btn.disabled = false;
            start_btn.value = "Start";
            vnc_status.textContent = "Finished";
        }

        window.onscriptsload = function () {
            iterations = WebUtil.getQueryVar('iterations', 1);
            skipframes = WebUtil.getQueryVar('skipframes', 0);
            messageon = WebUtil.getQueryVar('message', 0);

            iters.value = iterations;
            jumpto.value = skipframes;
            mode = WebUtil.getQueryVar('mode', 3);

            if (mode === 'fullspeed') {
                mode1.checked = true;
            } else {
                mode2.checked = true;
            }
            if (messageon) {
                cell.style.display = 'block';
            }
            if (fname) {
                message("VNC_frame_data.length: " + VNC_frame_data.length);
                trackbar.max = VNC_frame_data.length;
                trackbar.style.display = "inline-block";
            }
            // Play immediately after load the data
            start_btn.disabled = false;
            vnc_status.textContent = "Loaded";

            start();
        }
    </script>
</html>
