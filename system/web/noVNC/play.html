<!DOCTYPE html>
<html>
    <head>
        <title>Cloud Lab VNC Player</title>
    </head>
    <body>

        <div id="VNC_control">
	    <input id='startButton' type='button' value='Start' style='min-width:50px'
		    onclick="start();" disabled>
            <input type="range" id="trackBar" min="1" max="10" step="1" value="1" style="display: none;vertical-align: top" />

	    &nbsp; Session:<span id="session" style="color: #f00;"></span>:<span id="iteration" style="color: #33f;"></span>:<span id="frame_idx" style="color: #00f;"></span>
            &nbsp; Iterations:<input id='iterations' style="width:25px; text-align: center">
            &nbsp; skipFrames:<input id='skipframes' style="width:25px; text-align: center">
            &nbsp; Fullspeed:<input type='radio' id='mode1' name='mode' style="vertical-align: top">
            &nbsp; Realtime:<input type='radio' id='mode2' name='mode' style="vertical-align: top" checked><br>
            <textarea id="messages" style="font-size: 9; margin-top: 10px; display: none;" cols=80 rows=5></textarea><br>
        </div>

        <div id="VNC_screen">
            <canvas id="VNC_canvas" width="480px" height="20px">
                Canvas not supported.
            </canvas>
            <div id="VNC_status_bar" class="VNC_status_bar" style="margin-top: 0px">
                <table border=0 width=100%><tr>
                    <td><div id="VNC_status" style="text-align: center">Loading</div></td>
                </tr></table>
            </div>
        </div>
    </body>

    <!--
    <script type='text/javascript'
        src='http://getfirebug.com/releases/lite/1.2/firebug-lite-compressed.js'></script>
    -->

    <script type="text/javascript">
        var INCLUDE_URI= "./";
    </script>
    <script src="./core/util.js"></script>
    <script src="./app/webutil.js"></script>

    <script>
	// play Stats
        var playStats = {
	    INIT: 0,
	    LOADING: 1,
	    RUNNING: 2,
	    STOPPED: 3,
        };

        var fname, start_time, play_stats;
	var trackbar = document.getElementById('trackBar');

        play_stats = playStats.INIT;

        function message(str) {
            console.log(str);
            var cell = document.getElementById('messages');
            cell.textContent += str + "\n";
            cell.scrollTop = cell.scrollHeight;
        }

        function updatestats(iteration, frame_idx) {
	    document.getElementById('iteration').textContent = iteration;
	    document.getElementById('frame_idx').textContent = frame_idx + 1;

            trackbar.value = frame_idx + 1;
        }

        fname = WebUtil.getQueryVar('data', null);
        if (fname) {
            message("Loading " + fname);
	    document.getElementById('session').textContent = fname;
            document.getElementById('startButton').value = 'Loading "' + fname + '"';
            // Load supporting scripts
            WebUtil.load_scripts({
                'core': ["base64.js", "websock.js", "des.js", "input/keysym.js",
                         "input/keysymdef.js", "input/xtscancodes.js", "input/util.js",
                         "input/devices.js", "display.js", "rfb.js", "inflator.js"],
                'tests': ["playback.js"],
                'recordings': [fname]});

            play_stats = playStats.LOADING;

        } else {
            message("Must specify data=FOO in query string.");
        }

        disconnected = function (rfb, reason) {
            if (reason) {
                message("noVNC sent '" + state + "' state during iteration " + iteration + " frame " + frame_idx);
                test_state = 'failed';
            }
        }

        notification = function (rfb, mesg, level, options) {
            document.getElementById('VNC_status').textContent = mesg;
        }

        function __start() {
            play_stats = playStats.RUNNING;
            iteration = 0;

            document.getElementById('startButton').value = 'Stop';

            start_time = (new Date()).getTime();
 
            document.getElementById('VNC_status').textContent = "Running";
            message("Start play the " + skipframes + " Frame");

            //recv_message = rfb.testMode(send_array, VNC_frame_encoding);

            next_iteration();
        }

	function __stop() {
	    play_stats = playStats.STOPPED;
	    document.getElementById('startButton').value = 'Continue';
            document.getElementById('startButton').disabled = false;
	    document.getElementById('VNC_status').textContent = "Stopped";
	    message("Stopped at the " + frame_idx + " frame!");
	}

	function __continue() {
            document.getElementById('startButton').value = 'Stop';
	    document.getElementById('VNC_status').textContent = "Continued";

	    if (mode === 'fullspeed') { window.setImmediate(do_packet); }
	    else { setTimeout(do_packet, delay); }

	    if ((frame_idx < skipframes) && (mode === 'realtime'))
	        mode = 'fullspeed';

	    play_stats = playStats.RUNNING;
	    message("Continue play the " + frame_idx + " frame!");
	}

	function start() {
            skipframes = document.getElementById('skipframes').value;
            iterations = document.getElementById('iterations').value;

            if (document.getElementById('mode1').checked || (skipframes > frame_idx)) {
                message("Starting performance playback (fullspeed) [" + iterations + " iteration(s)]");
                mode = 'fullspeed';
            } else {
                message("Starting realtime playback [" + iterations + " iteration(s)]");
                mode = 'realtime';
            }

            //console.info("play stats is " + play_stats);
	    if (play_stats != playStats.RUNNING) {
		if (play_stats === playStats.STOPPED)
		    __continue();
		else
		    __start();
	    } else {
		__stop();
	    }
	}

        function finish() {
            // Finished with all iterations
            var total_time, end_time = (new Date()).getTime();
            total_time = end_time - start_time;

            iter_time = parseInt(total_time / iterations, 10);
            message(iterations + " iterations took " + total_time + "ms, " +
                    iter_time + "ms per iteration");
            // Shut-off event interception
            rfb.get_mouse().ungrab();
            rfb.get_keyboard().ungrab();
            play_stats = playStats.INIT;

            document.getElementById('startButton').disabled = false;
            document.getElementById('startButton').value = "Start";
            document.getElementById('VNC_status').textContent = "Finished";
        }

        window.onscriptsload = function () {
            iterations = WebUtil.getQueryVar('iterations', 1);
            skipframes = WebUtil.getQueryVar('skipframes', 0);
            messageon = WebUtil.getQueryVar('message', 0);

            document.getElementById('iterations').value = iterations;
            document.getElementById('skipframes').value = skipframes;
            mode = WebUtil.getQueryVar('mode', 3);
            if (mode === 'fullspeed') {
                document.getElementById('mode1').checked = true;
            } else {
                document.getElementById('mode2').checked = true;
            }
            if (messageon) {
                document.getElementById('messages').style.display = 'block';
            }
            if (fname) {
                message("VNC_frame_data.length: " + VNC_frame_data.length);
            }
            // Play immediately after load the data
            document.getElementById('startButton').disabled = false;
            document.getElementById('VNC_status').textContent = "Loaded";

            trackbar.style.display = "inline-block";
            trackbar.max = VNC_frame_data.length;

            start();
        }
    </script>
</html>
